import{Y as u,u as h,P as r}from"./index-DwXYDVfX.js";const d=u("chat",{state:()=>({conversations:[],activeChatId:null,activeChatType:null,messages:{},unreadCounts:{},isCallIncoming:!1,incomingCallData:null,friendRequestCount:0,groupRequestCount:0}),getters:{totalUnread:t=>t.conversations.reduce((n,s)=>n+(s.unread||0),0),totalRequests:t=>t.friendRequestCount+t.groupRequestCount},actions:{async fetchRequestCounts(){try{const[t,n]=await Promise.all([r.get("/friend/requests"),r.get("/group/requests")]);this.friendRequestCount=(t||[]).filter(s=>s.status===0).length,this.groupRequestCount=(n||[]).filter(s=>s.status===0).length}catch(t){console.error(t)}},async fetchConversations(){const[t,n]=await Promise.all([r.get("/friend/list"),r.get("/group/my-groups")]),s=(t||[]).map(e=>({id:e.id,name:e.nickname||e.username,avatar:e.avatar?e.avatar.startsWith("http")?e.avatar:`${window.location.protocol}//${window.location.hostname}:8000${e.avatar}`:"",type:"private",unread:e.unread_count||0,lastMsg:e.content||"",lastTime:e.last_message_time?new Date(e.last_message_time*1e3).toLocaleString():""}))(t||[]).forEach(e=>{if(e?.avatar&&e?.id){const i=e.avatar.startsWith("http")?e.avatar:`${window.location.protocol}//${window.location.hostname}:8000${e.avatar}`;localStorage.setItem(`avatar_${e.id}`,i)}}),a=(n||[]).map(e=>({id:e.id,name:e.name,avatar:e.icon?e.icon.startsWith("http")?e.icon:`${window.location.protocol}//${window.location.hostname}:8000${e.icon}`:"",type:"group",unread:e.unread_count||0,lastMsg:e.content||"",lastTime:e.last_message_time?new Date(e.last_message_time*1e3).toLocaleString():""}));this.conversations=[...s,...a]},setActiveChat(t){this.activeChatId=t;const n=this.conversations.find(a=>a.id===t);n&&(this.activeChatType=n.type,this.fetchHistory(t,n.type==="private"?2:3)),this.unreadCounts[t]&&(this.unreadCounts[t]=0);const s=this.conversations.findIndex(a=>a.id===t);s!==-1&&(this.conversations[s].unread=0)},async fetchHistory(t,n){if(!(this.messages[t]&&this.messages[t].length>0))try{const a=(await r.get("/chat/history",{params:{target_id:t,chat_type:n}})||[]).map(e=>({id:e.id,content:e.content,from_id:e.from_user_id,target_id:e.to_user_id,type:e.type,media:e.media,send_time:e.created_at}));this.messages[t]=a}catch(s){console.error("Failed to fetch history",s)}},receiveMessage(t){const n=h();let s;if(t.type===o.GroupMsg?s=t.target_id:s=t.from_id===n.userInfo?.ID?t.target_id:t.from_id,this.messages[s]||(this.messages[s]=[]),this.messages[s].push(t),this.activeChatId!==s){this.unreadCounts[s]=(this.unreadCounts[s]||0)+1;const a=this.conversations.findIndex(e=>e.id===s);if(a!==-1){this.conversations[a].unread=(this.conversations[a].unread||0)+1,this.conversations[a].lastMsg=t.content,this.conversations[a].lastTime=new Date().toLocaleString();const e=this.conversations.splice(a,1)[0];this.conversations.unshift(e)}}else{const a=this.conversations.findIndex(e=>e.id===s);a!==-1&&(this.conversations[a].lastMsg=t.content,this.conversations[a].lastTime=new Date().toLocaleString())}},async sendMessage(t,n,s){const a={type:n,target_id:s,content:t,media:1};this.pushTempMessage(a,s),l.send(a)},async sendMediaMessage(t,n,s,a){const e={type:n,target_id:s,content:t,media:a};this.pushTempMessage(e,s),l.send(e)},pushTempMessage(t,n){const s=h(),a={...t,from_id:s.userInfo?.ID||"me",send_time:Date.now()/1e3,status:"sending"};this.messages[n]||(this.messages[n]=[]),this.messages[n].push(a)},handleWebRTC(t){this.isCallIncoming=!0,this.incomingCallData=t}}}),o={Heartbeat:0,SingleMsg:2,GroupMsg:3,WebRTC:4};class m{ws=null;heartbeatTimer=null;reconnectTimer=null;reconnectAttempts=0;maxReconnectDelay=3e4;connect(){const n=h();if(!n.token)return;this.ws&&this.ws.close();const s=location.protocol==="https:"?"wss":"ws",a=location.host,e=`${s}://${a}/api/ws?token=${n.token}`;this.ws=new WebSocket(e),this.ws.onopen=()=>{console.log("WS Connected"),this.reconnectAttempts=0,this.startHeartbeat()},this.ws.onmessage=i=>{try{const c=JSON.parse(i.data);this.handleMessage(c)}catch(c){console.error("WS Parse Error",c)}},this.ws.onclose=()=>{console.log("WS Closed"),this.stopHeartbeat(),this.reconnect()},this.ws.onerror=i=>{console.error("WS Error",i)}}handleMessage(n){const s=d();switch(n.type){case o.Heartbeat:break;case o.SingleMsg:case o.GroupMsg:s.receiveMessage(n);break;case o.WebRTC:s.handleWebRTC(n);break;default:console.log("Unknown msg type",n)}}send(n){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(n)):console.warn("WS not connected, cannot send",n)}startHeartbeat(){this.stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.send({type:o.Heartbeat,content:"ping"})},3e4)}stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}reconnect(){if(this.reconnectTimer)return;const n=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);this.reconnectAttempts++,this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connect()},n)}disconnect(){this.stopHeartbeat(),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null)}}const l=new m;export{d as u,l as w};
