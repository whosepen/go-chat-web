import{P as u,u as h,H as a}from"./index-DdbpnQh1.js";const d=u("chat",{state:()=>({conversations:[],activeChatId:null,activeChatType:null,messages:{},unreadCounts:{},isCallIncoming:!1,incomingCallData:null,friendRequestCount:0,groupRequestCount:0}),getters:{totalUnread:e=>e.conversations.reduce((n,t)=>n+(t.unread||0),0),totalRequests:e=>e.friendRequestCount+e.groupRequestCount},actions:{async fetchRequestCounts(){try{const[e,n]=await Promise.all([a.get("/friend/requests"),a.get("/group/requests")]);this.friendRequestCount=(e||[]).filter(t=>t.status===0).length,this.groupRequestCount=(n||[]).filter(t=>t.status===0).length}catch(e){console.error(e)}},async fetchConversations(){const[e,n]=await Promise.all([a.get("/friend/list"),a.get("/group/my-groups")]),t=(e||[]).map(s=>({id:s.id,name:s.nickname||s.username,avatar:s.avatar,type:"private",unread:s.unread_count||0,lastMsg:s.content||"",lastTime:s.last_message_time?new Date(s.last_message_time*1e3).toLocaleString():""})),i=(n||[]).map(s=>({id:s.id,name:s.name,avatar:s.icon,type:"group",unread:s.unread_count||0,lastMsg:s.content||"",lastTime:s.last_message_time?new Date(s.last_message_time*1e3).toLocaleString():""}));this.conversations=[...t,...i]},setActiveChat(e){this.activeChatId=e;const n=this.conversations.find(i=>i.id===e);n&&(this.activeChatType=n.type,this.fetchHistory(e,n.type==="private"?2:3)),this.unreadCounts[e]&&(this.unreadCounts[e]=0);const t=this.conversations.findIndex(i=>i.id===e);t!==-1&&(this.conversations[t].unread=0)},async fetchHistory(e,n){if(!(this.messages[e]&&this.messages[e].length>0))try{const i=(await a.get("/chat/history",{params:{target_id:e,chat_type:n}})||[]).map(s=>({id:s.id,content:s.content,from_id:s.from_user_id,target_id:s.to_user_id,type:s.type,media:s.media,send_time:s.created_at}));this.messages[e]=i}catch(t){console.error("Failed to fetch history",t)}},receiveMessage(e){const n=h();let t;if(e.type===o.GroupMsg?t=e.target_id:t=e.from_id===n.userInfo?.ID?e.target_id:e.from_id,this.messages[t]||(this.messages[t]=[]),this.messages[t].push(e),this.activeChatId!==t){this.unreadCounts[t]=(this.unreadCounts[t]||0)+1;const i=this.conversations.findIndex(s=>s.id===t);if(i!==-1){this.conversations[i].unread=(this.conversations[i].unread||0)+1,this.conversations[i].lastMsg=e.content,this.conversations[i].lastTime=new Date().toLocaleString();const s=this.conversations.splice(i,1)[0];this.conversations.unshift(s)}}else{const i=this.conversations.findIndex(s=>s.id===t);i!==-1&&(this.conversations[i].lastMsg=e.content,this.conversations[i].lastTime=new Date().toLocaleString())}},async sendMessage(e,n,t){const i={type:n,target_id:t,content:e,media:1};this.pushTempMessage(i,t),l.send(i)},async sendMediaMessage(e,n,t,i){const s={type:n,target_id:t,content:e,media:i};this.pushTempMessage(s,t),l.send(s)},pushTempMessage(e,n){const t=h(),i={...e,from_id:t.userInfo?.ID||"me",send_time:Date.now()/1e3,status:"sending"};this.messages[n]||(this.messages[n]=[]),this.messages[n].push(i)},handleWebRTC(e){this.isCallIncoming=!0,this.incomingCallData=e}}}),o={Heartbeat:0,SingleMsg:2,GroupMsg:3,WebRTC:4};class m{ws=null;heartbeatTimer=null;reconnectTimer=null;reconnectAttempts=0;maxReconnectDelay=3e4;connect(){const n=h();if(!n.token)return;this.ws&&this.ws.close();const t=location.protocol==="https:"?"wss":"ws",i=location.host,s=`${t}://${i}/api/ws?token=${n.token}`;this.ws=new WebSocket(s),this.ws.onopen=()=>{console.log("WS Connected"),this.reconnectAttempts=0,this.startHeartbeat()},this.ws.onmessage=r=>{try{const c=JSON.parse(r.data);this.handleMessage(c)}catch(c){console.error("WS Parse Error",c)}},this.ws.onclose=()=>{console.log("WS Closed"),this.stopHeartbeat(),this.reconnect()},this.ws.onerror=r=>{console.error("WS Error",r)}}handleMessage(n){const t=d();switch(n.type){case o.Heartbeat:break;case o.SingleMsg:case o.GroupMsg:t.receiveMessage(n);break;case o.WebRTC:t.handleWebRTC(n);break;default:console.log("Unknown msg type",n)}}send(n){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(n)):console.warn("WS not connected, cannot send",n)}startHeartbeat(){this.stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.send({type:o.Heartbeat,content:"ping"})},3e4)}stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}reconnect(){if(this.reconnectTimer)return;const n=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);this.reconnectAttempts++,this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connect()},n)}disconnect(){this.stopHeartbeat(),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null)}}const l=new m;export{d as u,l as w};
